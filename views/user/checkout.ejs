<!-- <!DOCTYPE html>
<html lang="en"> -->


<!-- molla/html  22 Nov 2019 09:55:06 GMT -->

<!-- <head> -->
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Molla - Bootstrap eCommerce Template</title>
<meta name="keywords" content="HTML5 Template">
<meta name="description" content="Molla - Bootstrap eCommerce Template">
<meta name="author" content="p-themes">
<!-- Favicon -->
<link rel="apple-touch-icon" sizes="180x180" href="/assets-checkout/images/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets-checkout/images/icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets-checkout/images/icons/favicon-16x16.png">
<link rel="manifest" href="/assets-checkout/images/icons/site.html">
<link rel="mask-icon" href="/assets-checkout/images/icons/safari-pinned-tab.svg" color="#666666">
<link rel="shortcut icon" href="/assets-checkout/images/icons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Molla">
<meta name="application-name" content="Molla">
<meta name="msapplication-TileColor" content="#cc9966">
<meta name="msapplication-config" content="/assets-checkout/images/icons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">
<!-- Plugins CSS File -->
<link rel="stylesheet" href="/assets-checkout/css/bootstrap.min.css">
<!-- Main CSS File -->
<link rel="stylesheet" href="/assets-checkout/css/style.css">
<!-- </head> -->

<div class="container" style="margin-top: 8em;">
    <div class="page-wrapper" style="border-top:0.7px solid lightgray;">


        <main class="main">
            <nav aria-label="breadcrumb" class="breadcrumb-nav">
                <div class="container">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                        <li class="breadcrumb-item"><a href="#">Shop</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Cart</li>
                    </ol>
                </div><!-- End .container -->
            </nav><!-- End .breadcrumb-nav -->

            <div class="page-content">
                <div class="">
                    <div class="container">
                        <div class="discount w-100 d-flex justify-content-start" style="margin-bottom: 3.5em;">
                            <form id="coupon-data" class="w-50">
                                <div class="input-group">
                                    <input type="text" class="form-control"
                                        placeholder="Have a coupon? Click here to enter your code"
                                        aria-label="coupon-code" aria-describedby="basic-addon2" id="coupon-code"
                                        name="couponCode" style="border: 1px dashed gray;border-radius:0.4em;">
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary" type="submit">Add</button>
                                    </div>
                                </div>
                                <p class="text-danger" id="coupon-error"><!-- already used --></p>
                            </form>
                        </div><!-- End .discount -->
                        <form id="placeOrder">
                            <div class="row">
                                <div class="col-lg-7">
                                    <h2 class="title mb-3">Billing Details</h2><!-- End .title -->
                                    <% addresses.forEach((el,index)=>{ %>
                                        <div class="card w-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <h5 class="card-title mt-2">Address <%= index+1 %>
                                                    </h5>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="radio" name="address"
                                                            id="addressRadio" value="<%= el._id %>">
                                                    </div>
                                                </div>
                                                <p class="card-text" style="margin: 1em 0;">
                                                    <%= el.fullName %>, <%= el.city %>, <%= el.landMark %>,<br>
                                                                <%= el.district %>, <%= el.state %>, <%= el.country %>,
                                                                            <%= el.pincode %>
                                                </p>
                                            </div>
                                        </div>
                                        <% }) %>


                                            <a href="" class="d-flex btn btn-primary w-25 mb-1 float-right"
                                                data-toggle="modal" data-target="#new-address" data-whatever="@mdo">New
                                                Address</a>
                                            <!-- new address modal start -->
                                            <div class="modal fade" id="new-address" tabindex="-1" role="dialog"
                                                aria-labelledby="exampleModalLabel" aria-hidden="true">
                                                <div class="modal-dialog" role="document">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title" id="exampleModalLabel">Add Address
                                                            </h5>
                                                            <button type="button" class="close" data-dismiss="modal"
                                                                aria-label="Close">
                                                                <span aria-hidden="true">&times;</span>
                                                            </button>
                                                        </div>
                                                        <div class="modal-body p-5 pt-1">
                                                            <form>
                                                                <div class="form-group col-md-12 col-12">
                                                                    <label for="fullName" class="col-form-label">Full
                                                                        Name</label>
                                                                    <input type="text" class="form-control"
                                                                        id="fullName"
                                                                        style="border: 1px solid gray;border-radius: 0.2em;">
                                                                </div>
                                                                <div class="form-group col-md-6 col-12">
                                                                    <label for="country"
                                                                        class="col-form-label">Country</label>
                                                                    <input type="text" class="form-control" id="country"
                                                                        style="border: 1px solid gray;border-radius: 0.2em;">
                                                                </div>
                                                                <div class="form-group col-md-6 col-12">
                                                                    <label for="state"
                                                                        class="col-form-label">State</label>
                                                                    <input type="text" class="form-control" id="state"
                                                                        style="border: 1px solid gray;border-radius: 0.2em;">
                                                                </div>
                                                                <div class="form-group col-md-12 col-12">
                                                                    <label for="district"
                                                                        class="col-form-label">District</label>
                                                                    <input type="text" class="form-control"
                                                                        id="district"
                                                                        style="border: 1px solid gray;border-radius: 0.2em;">
                                                                </div>
                                                                <div class="form-group col-md-12 col-12">
                                                                    <label for="city"
                                                                        class="col-form-label">City</label>
                                                                    <input type="text" class="form-control" id="city"
                                                                        style="border: 1px solid gray;border-radius: 0.2em;">
                                                                </div>
                                                                <div class="form-group col-12 col-md-6">
                                                                    <label for="pincode"
                                                                        class="col-form-label">Pincode</label>
                                                                    <input type="text" class="form-control" id="pincode"
                                                                        style="border: 1px solid gray;border-radius: 0.2em;">
                                                                </div>
                                                                <div class="form-group col-12 col-md-6">
                                                                    <label for="mobile"
                                                                        class="col-form-label">Mobile</label>
                                                                    <input type="text" class="form-control" id="mobile"
                                                                        style="border: 1px solid gray;border-radius: 0.2em;">
                                                                </div>
                                                                <div class="form-group col-md-12 col-12">
                                                                    <label for="landMark" class="col-form-label">Land
                                                                        Mark</label>
                                                                    <input type="text" class="form-control"
                                                                        id="landMark"
                                                                        style="border: 1px solid gray;border-radius: 0.2em;">
                                                                </div>
                                                                <div class="w-100 d-flex justify-content-center">
                                                                    <button type="button"
                                                                        class="btn btn-primary w-25">Add
                                                                        Address</button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                        <!--   <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                                        </div> -->
                                                    </div>
                                                </div>
                                            </div>
                                </div><!-- End .col-lg-9 -->

                                <style>
                                    .btn {
                                        color: white;
                                        background: black;
                                        border-radius: .4em;
                                        height: 2.7em;
                                        font-size: 1em;
                                        width: 50%;
                                        border: black;
                                    }

                                    .btn:hover {
                                        background: rgba(34, 34, 34, 0.787);
                                        height: 2.7em;
                                        align-items: center;
                                        font-size: 1em;
                                    }
                                </style>

                                <aside class="col-lg-5">
                                    <div class="summary">
                                        <h3 class="summary-title">Your Order</h3><!-- End .summary-title -->
                                        <% if(users){ %>

                                            <table class="table table-summary">
                                                <thead>
                                                    <tr>
                                                        <th>
                                                            <h5>Product</h5>
                                                        </th>
                                                        <th>
                                                            <h5>Total</h5>
                                                        </th>
                                                    </tr>
                                                </thead>

                                                <tbody>
                                                    <% for(let i=0; i<cartItems.items.length;i++){ let
                                                        eachItem=cartItems.items[i]%>
                                                        <tr>
                                                            <td>
                                                                <a class="d-flex align-items-center" href="">
                                                                    <img class="me-3"
                                                                        src="<%= eachItem.productId.images[0] %>" alt=""
                                                                        width="50" height="50">
                                                                    <p href="#">
                                                                        <%= eachItem.productId.tittle %>&nbsp;&nbsp;X
                                                                            <%= eachItem.qty %>
                                                                    </p>

                                                                </a>
                                                            </td>
                                                            <td>
                                                                $<%= eachItem.productId.price %>
                                                            </td>

                                                        </tr>
                                                        <% } %>
                                                            <tr class="summary-subtotal">
                                                                <td>Subtotal:</td>
                                                                <td>$<%= users.cart.totalPrice %>.00</td>
                                                            </tr><!-- End .summary-subtotal -->
                                                            <tr>
                                                                <td>Coupon:</td>
                                                                <td>$<span id="discount">00</span>.00
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td>Shipping:</td>
                                                                <td>Free shipping</td>
                                                            </tr>
                                                            <tr class="summary-total">
                                                                <td>Total:</td>
                                                                <td>$<span id="total">
                                                                        <%= users.cart.totalPrice %>
                                                                    </span>.00</td>
                                                            </tr><!-- End .summary-total -->
                                                </tbody>
                                            </table><!-- End .table table-summary -->

                                            <% } %>

                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="paymentMethod"
                                                        id="flexRadioDefault1" value="COD">
                                                    <label class="form-check-label" for="flexRadioDefault1">
                                                        Cash On Delivery
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="paymentMethod"
                                                        id="flexRadioDefault2" value="razoorPay">
                                                    <label class="form-check-label" for="flexRadioDefault2">
                                                        Razorpay
                                                    </label>
                                                </div>

                                                <div class="d-flex justify-content-center">
                                                    <button id="place-order" type="submit"
                                                        class="btn btn-dark text-white btn-block rounded-2">
                                                        Place order
                                                    </button>
                                                </div>
                                                <style>
                                                    #place-order:hover {
                                                        background: rgba(34, 34, 34, 0.787);
                                                        color: white;
                                                        border: rgba(34, 34, 34, 0.787);
                                                    }
                                                </style>
                                    </div><!-- End .summary -->
                                </aside><!-- End .col-lg-3 -->
                            </div><!-- End .row -->
                        </form>
                    </div><!-- End .container -->
                </div><!-- End .-->
            </div><!-- End .page-content -->
        </main><!-- End .main -->
    </div><!-- End .page-wrapper -->
    <!-- Mobile Menu -->

    <!-- Plugins JS File -->
    <script src="/assets-checkout/js/jquery.min.js"></script>
    <script src="/assets-checkout/js/bootstrap.bundle.min.js"></script>
    <script src="/assets-checkout/js/jquery.hoverIntent.min.js"></script>
    <script src="/assets-checkout/js/jquery.waypoints.min.js"></script>
    <script src="/assets-checkout/js/superfish.min.js"></script>
    <!--   <script src="/assets-checkout/js/owl.carousel.min.js"></script> -->
    <!-- Main JS File -->
    <script src="/assets-checkout/js/main.js"></script>

    <script>
        const coupon = document.querySelector('#coupon-data');
        coupon.addEventListener('submit', event => {
            event.preventDefault()
            console.log($('#coupon-data').serialize());
            $.ajax({
                url: '/couponGenerate',
                method: 'post',
                dataType: 'json',
                encode: true,
                data: $('#coupon-data').serialize(),
            }).done((data) => {
                if (data.expiry) {
                    $('#coupon-error').html('sorry...this coupon is expired!')
                } else {
                    $('#coupon-error').html('')
                    if (data.error == true) {
                        $('#coupon-error').html('coupon not found!')
                        $('#discount').html('00')
                    } else {
                        if (data.status) {
                            $('#coupon-error').html('')
                            $('#discount').html(data.discount)
                            $('#total').html(data.total)
                        } else {
                            if (data.used) {
                                $('#coupon-error').html('Already Used!')
                            }
                            if (data.status == false) {
                                console.log(data.min);
                                $('#coupon-error').html('minium cart amount is ' + data.min)
                            }
                        }
                    }
                    $('#total').html(data.total)
                }
            })
        })


        const placeOrder = document.querySelector('#placeOrder');
        placeOrder.addEventListener('submit', event => {
            event.preventDefault()
            let total = $('#total').text()
            let couponCode = $('#coupon-code').val()
            total = total.trim()
            const editForm = document.getElementById("placeOrder");
            const formData = new FormData(editForm);
            let dataToSend = Object.fromEntries(formData);
            Swal.fire({
                title: 'Are you sure?',
                text: "Do you want to place the order?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/placeOrder',
                        method: 'post',
                        dataType: 'json',
                        encode: true,
                        data: {
                            data: dataToSend,
                            couponCode: couponCode,
                            total: parseInt(total)
                        }
                    }).done((data) => {
                        console.log(data)
                        if (data.codSuccess) {
                            window.location = '/orderSuccess'
                        }
                        if (data.razoorpay) {
                            razorpay(data.order)
                        }
                    })
                }
            })
        })

        // calling razorpay api
        const razorpay = function (order) {
            let options = {
                key: 'rzp_test_K0f5UoTs0ZVveC', // Enter the Key ID generated from the Dashboard
                amount: "50000", // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                currency: "USD",
                name: "URBANCART",
                description: "Purchase Transaction",
                image: "https://example.com/your_logo",
                order_id: order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                handler: function (response) {
                    verifyPayment(response, order)
                },
                prefill: {
                    name: "Mohammed Aslam",
                    email: "aslamtp11@gmail.com",
                    contact: "9048752691"
                },
                notes: {
                    address: "URBANCART Corporate Office"
                },
                theme: {
                    color: "#3399cc"
                }
            };
            var rzp1 = new Razorpay(options);
            rzp1.on("payment.failed", function (response) {
                alert(response.error.code);
                alert(response.error.description);
                alert(response.error.source);
                alert(response.error.step);
                alert(response.error.reason);
                alert(response.error.metadata.order_id);
                alert(response.error.metadata.payment_id);
            });
            rzp1.open();
        }

        // verification payment
        const verifyPayment = function (payment, order) {
            console.log('verifying....')
            $.ajax({
                url: '/verifyPayment',
                data: {
                    payment, order
                },
                method: 'post'
            }).done((data)=>{
                if(data.status==true){
                    console.log(data.status)
                    window.location = '/orderSuccess'
                }
            })
        }

    </script>